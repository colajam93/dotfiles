#!/usr/bin/env python3

import json
import os
import os.path
import shutil
import subprocess
from argparse import ArgumentParser
from contextlib import closing
from tempfile import TemporaryDirectory, NamedTemporaryFile
from typing import List
from urllib.parse import quote
from urllib.request import urlopen

OFFICIAL_AUR_URL = 'https://aur.archlinux.org'


def info_url(packages: List[str], server: str = OFFICIAL_AUR_URL) -> str:
    return server + '/rpc/?v=5&type=info&' + '&'.join(['arg[]={}'.format(quote(x)) for x in packages])


def query(url: str):
    with closing(urlopen(url)) as request:
        return json.loads(request.read().decode())


def do_export(query_dict, args) -> None:
    if query_dict['resultcount'] == 0:
        # TODO: Error message
        return
    with TemporaryDirectory() as temp_dir:
        for package in query_dict['results']:
            with NamedTemporaryFile(dir=temp_dir) as t:
                with closing(urlopen(OFFICIAL_AUR_URL + package['URLPath'])) as request:
                    t.write(request.read())
                    t.flush()
                subprocess.run(['tar', 'xvf', t.name, '-C', temp_dir], stderr=subprocess.DEVNULL)

        def listdir_only_directory(path: str) -> List[str]:
            def absolute_path(p: str) -> str:
                return os.path.join(path, p)

            return list(absolute_path(x) for x in os.listdir(path) if os.path.isdir(absolute_path(x)))

        output_directory = os.getcwd() if not args.directory else args.directory
        # TODO: Overwrite handling
        for d in listdir_only_directory(temp_dir):
            shutil.move(d, output_directory)


def do_query(query_dict, args) -> None:
    # TODO: Pretty output
    print(json.dumps(query_dict, indent=4))


def main() -> None:
    parser = ArgumentParser()
    parser.add_argument('package', nargs='+')
    parser.add_argument('--directory', '-d')
    group = parser.add_mutually_exclusive_group(required=True)
    group.add_argument('--query', '-Q', action='store_true')
    group.add_argument('--getpkgbuild', '-G', action='store_true')
    args = parser.parse_args()

    info_url_ = info_url(args.package)
    query_result = query(info_url_)
    if args.query:
        do_query(query_result, args)
    elif args.getpkgbuild:
        do_export(query_result, args)


if __name__ == '__main__':
    main()
